<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>MusArt - Check-in System</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
 <link rel="stylesheet" href="style.css">
</head>
<body>
 
  <div class="container">
    <div class="section fade-in">
      <h2 class="section-title">MusArt <br>Check-in Information</h2>
      <!-- <p style="text-align: center; margin-bottom: 20px; color: wheat;">
        Follow these steps for a smooth check-in process
      </p> -->
      
      <div class="video-container">
        <video controls onloadstart="this.volume=0.1">
          <source src="check-in4.mp4" type="video/mp4">
          Your browser does not support the video tag.
        </video>
      </div>
    </div>

    <div class="section fade-in">
      <div class="auth-container">
        <h2 class="tth2" id="tth2">Enter authorization Code to Access Door Controls:</h2>
        
        <div class="auth-form" id="auth-form">
          <div class="input-group">
            <input type="number" id="authCode" placeholder="Enter the access code we sent you">
          </div>
          <button id="btnCheckCode" class="btn pulse">
            <i class="fas fa-unlock-alt"></i> Submit Code
          </button>
        </div>
        
        <div id="controlPanel" class="control-panel">
          <div class="warning-box" id="warning-box">
            <h5><i class="fas fa-exclamation-triangle"></i> IMPORTANT: You only have 3 clicks</h5>
            <p>Use the buttons only for check-in</p>
          </div>
          
          <div class="door-control fade-in">
            <h3><i class="fas fa-building"></i> Main Entrance Door</h3>
            <button id="MainDoor" class="btn">
              <i class="fas fa-key"></i> Unlock Main Door
            </button>
          </div>

          <div class="door-control fade-in">
            <h3><i class="fas fa-home"></i> Apartment Door</h3>
            <button id="AptDoor" class="btn">
              <i class="fas fa-key"></i> Unlock Apartment Door
            </button>
          </div>
          
          <div class="status-bar">
            <div class="status-item">
              <div>Main Door Clicks</div>
              <div id="mainDoorClicks" class="status-value">3</div>
            </div>
            <div class="status-item">
              <div>Apartment Door Clicks</div>
              <div id="aptDoorClicks" class="status-value">3</div>
            </div>
            <div class="status-item">
              <div>Time Remaining</div>
              <div id="timeRemaining" class="status-value">60:00</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Popups -->
    <div id="popup-MainDoor" class="popup">
      <div class="popup-content">
        <h2><i class="fas fa-building"></i> Main Door</h2>
        <p id="popup-text-MainDoor"></p>
        <button class="btn" onclick="closePopup('MainDoor')">
          <i class="fas fa-times"></i> Close
        </button>
      </div>
    </div>

    <div id="popup-AptDoor" class="popup">
      <div class="popup-content">
        <h2><i class="fas fa-home"></i> Apartment Door</h2>
        <p id="popup-text-AptDoor"></p>
        <button class="btn" onclick="closePopup('AptDoor')">
          <i class="fas fa-times"></i> Close
        </button>
      </div>
    </div>

    <div class="section important fade-in" id="important">
      <h3><i class="fas fa-exclamation-circle"></i> IMPORTANT LEGAL REQUIREMENT</h3>
      <p>
        Before sending the access code, according to Italian law, I must register all guests on the official tourist portal. 
        Please send me photos of everyone's passports via Airbnb/Booking messaging or WhatsApp.
      </p>
    </div>

    <div class="contact-section">
      <h3>Need Assistance?</h3>
      <p>Contact us directly for support</p>
      <a class="contact-btn" href="https://api.whatsapp.com/send?phone=+393898883634&text=Hi, I need assistance with my check-in">
        <i class="fab fa-whatsapp"></i>
      </a>
    </div>
  </div>
  <script>
    const DEVICES = [
      { id: "e4b063f0c38c", storage_key: "clicks_MainDoor", button_id: "MainDoor" },
      { id: "34945478d595", storage_key: "clicks_AptDoor", button_id: "AptDoor" },
    ];

    let session = null;
    let timeCheckInterval;

    // --- Gestione codice di accesso ---
    async function handleCodeSubmit() {
      const insertedCode = document.getElementById("authCode").value.trim();
      const res = await fetch("/api/checkCode", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ code: insertedCode }),
      });

      if (!res.ok) {
        alert("Codice errato! Riprova.");
        return;
      }

      session = await res.json();

      // mostra pannello
      document.getElementById("controlPanel").style.display = "block";
      document.getElementById("auth-form").style.display = "none";

      // Aggiorna stato pulsanti
      DEVICES.forEach(updateButtonState);

      // Avvia controllo tempo
      checkTimeLimit();
      timeCheckInterval = setInterval(checkTimeLimit, 10000);
    }

    // --- Controlla tempo residuo ---
    async function checkTimeLimit() {
      if (!session) return;
      const res = await fetch("/api/status", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ startTime: session.startTime, hash: session.hash }),
      });
      const data = await res.json();

      if (data.expired) {
        showFatalError(data.reason || "Sessione scaduta!");
        return;
      }

      document.getElementById("timeRemaining").textContent =
        `${String(data.minutesLeft).padStart(2,"0")}:${String(data.secondsLeft).padStart(2,"0")}`;
    }

    // --- Attiva dispositivo ---
    async function activateDevice(device) {
      if (!session) return;

      const res = await fetch("/api/activateDevice", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ deviceId: device.id }),
      });

      const data = await res.json();
      const clicksLeft = data.clicksLeft ?? 0;

      if (data.success) {
        showDevicePopup(device, clicksLeft);
      } else {
        showDevicePopup(device, clicksLeft);
      }

      updateButtonState(device, clicksLeft);
    }

    // --- UI helpers ---
    function updateButtonState(device, clicksLeft = null) {
      const btn = document.getElementById(device.button_id);
      if (!btn) return;
      if (clicksLeft === null) return; // se non abbiamo dati nuovi, non aggiorniamo
      btn.disabled = clicksLeft <= 0;
      if (device.button_id === "MainDoor") {
        document.getElementById("mainDoorClicks").textContent = clicksLeft;
      } else {
        document.getElementById("aptDoorClicks").textContent = clicksLeft;
      }
    }

    function showDevicePopup(device, clicksLeft) {
      const popup = document.getElementById(`popup-${device.button_id}`);
      const text = document.getElementById(`popup-text-${device.button_id}`);

      if (clicksLeft > 0) {
        text.innerHTML = `
          <i class="fas fa-check-circle" style="color:#4CAF50; font-size:2.5rem;"></i>
          <div>Hai ancora <strong>${clicksLeft}</strong> click disponibili</div>
          <div>La porta Ã¨ stata sbloccata!</div>`;
      } else {
        text.innerHTML = `
          <i class="fas fa-exclamation-triangle" style="color:#FFC107; font-size:2.5rem;"></i>
          <div><strong>Nessun click rimanente!</strong></div>`;
      }

      popup.style.display = "flex";
      if (clicksLeft > 0) {
        setTimeout(() => closePopup(device.button_id), 3000);
      }
    }

    function closePopup(buttonId) {
      const popup = document.getElementById(`popup-${buttonId}`);
      if (popup) popup.style.display = "none";
    }

    function showFatalError(message) {
      clearInterval(timeCheckInterval);
      document.body.innerHTML = `
        <div style="
          position:fixed; top:0; left:0; width:100%; height:100vh;
          display:flex; justify-content:center; align-items:center;
          background:#121111; color:#ff6b6b; font-size:24px;
          text-align:center; padding:20px; z-index:9999;">
          ${message}
        </div>`;
    }

    // --- Inizializzazione ---
    function init() {
      document.getElementById("btnCheckCode")
        .addEventListener("click", handleCodeSubmit);

      DEVICES.forEach(device => {
        const btn = document.getElementById(device.button_id);
        if (btn) {
          btn.addEventListener("click", () => activateDevice(device));
        }
      });

      document.querySelectorAll(".popup .btn").forEach(button => {
        button.addEventListener("click", function() {
          const popup = this.closest(".popup");
          if (popup) closePopup(popup.id.replace("popup-",""));
        });
      });
    }

    document.addEventListener("DOMContentLoaded", init);
  </script>
</body>
</html>